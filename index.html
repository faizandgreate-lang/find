<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Location Finder — Mobile Mode</title>
<style>
  :root{
    --card-bg: rgba(255,255,255,0.86);
    --btn-bg: rgba(255,255,255,0.94);
    --text-color: #111;
    --muted: rgba(0,0,0,0.55);
    --accent: #0b74ff;
  }
  html,body{height:100%;margin:0;font-family:"Merriweather",serif;-webkit-font-smoothing:antialiased;}
  body{display:flex;flex-direction:column;align-items:center;min-height:100vh;color:var(--text-color);background:#fff;overflow-x:hidden;position:relative;transition:background .6s,color .6s;}

  /* map container */
  #mapFrameWrap{ width:100%; height:260px; border-radius:12px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04); position:relative; }
  iframe#osm-map{ width:100%; height:100%; border:0; display:block; }
  
  /* spinner */
  #spinner{
    display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10;
  }
  #spinner div{
    border:4px solid rgba(0,0,0,0.1); border-top:4px solid var(--accent); border-radius:50%; width:36px; height:36px;
    animation:spin 0.8s linear infinite;
  }
  @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

  /* basic UI */
  #card{ width:92%; max-width:480px; margin:16px auto; padding:14px; border-radius:14px; background:var(--card-bg); backdrop-filter:blur(8px) saturate(110%);}
  #output{ margin-top:8px; font-size:14px; color:var(--text-color); }
  .btn{ padding:10px 14px; margin:4px; border:none;border-radius:12px; background:var(--btn-bg); font-weight:700; cursor:pointer; }
</style>
</head>
<body>

<div id="card">
  <div id="mapFrameWrap">
    <iframe id="osm-map" src="https://www.openstreetmap.org/export/embed.html?bbox=46.665,24.705,46.685,24.725&layer=mapnik&marker=24.7136,46.6753" loading="lazy"></iframe>
    <div id="spinner"><div></div></div>
  </div>
  <div id="output">Results will appear here</div>
  <button class="btn" id="btnZip">Get My ZIP Code</button>
  <button class="btn" id="btnAddress">Get My Address</button>
  <button class="btn" id="btnNearby">List Nearby Places</button>
</div>

<script>
/* ===== FORCE MOBILE MODE ===== */
const isMobile = true;

/* ===== Spinner helpers ===== */
function showSpinner(show=true){ document.getElementById('spinner').style.display = show?'block':'none'; }

/* ===== GEO functions ===== */
function getLocation(){
  return new Promise((resolve,reject)=>{
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>resolve({lat:pos.coords.latitude,lon:pos.coords.longitude}), err=>reject(err));
    } else reject(new Error('Geolocation not supported'));
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

async function getZip(){
  try{
    showSpinner(true);
    output.innerText='Finding ZIP code…';
    const loc = await getLocation();
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${loc.lat}&lon=${loc.lon}&format=json`);
    const data = await res.json();
    const zip = data.address?.postcode || 'Not found';
    output.innerHTML=`<strong>ZIP Code:</strong> ${escapeHtml(zip)}`;
    updateMap(loc.lat, loc.lon);
  }catch(err){ output.innerText='Could not get ZIP — '+(err.message||err); }
  finally{ showSpinner(false); }
}

async function getAddress(){
  try{
    showSpinner(true);
    output.innerText='Finding address…';
    const loc = await getLocation();
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${loc.lat}&lon=${loc.lon}&format=json`);
    const data = await res.json();
    output.innerHTML=`<strong>Address:</strong> ${escapeHtml(data.display_name||'Not found')}`;
    updateMap(loc.lat, loc.lon);
  }catch(err){ output.innerText='Could not get address — '+(err.message||err); }
  finally{ showSpinner(false); }
}

function getDistance(lat1, lon1, lat2, lon2){
  const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c;
}

async function listNearby(){
  try{
    showSpinner(true);
    output.innerText='Searching nearby…';
    const loc = await getLocation();
    updateMap(loc.lat, loc.lon);
    const query=`[out:json];(node(around:1000,${loc.lat},${loc.lon})[amenity];way(around:1000,${loc.lat},${loc.lon})[amenity];);out center 20;`;
    const res=await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
    const data = await res.json();
    if(!data.elements?.length){ output.innerText='No nearby places found.'; return; }
    let html='<table><tr><th>Place</th><th>Type</th><th>Dist (m)</th><th>Walk (min)</th></tr>';
    data.elements.slice(0,20).forEach(el=>{
      const lat = el.lat || el.center?.lat, lon = el.lon || el.center?.lon;
      const name = el.tags?.['name:en'] || el.tags?.name || el.tags?.amenity || 'Place';
      const type = el.tags?.amenity || 'Unknown';
      const dist = Math.round(getDistance(loc.lat,loc.lon,lat,lon)*1000);
      const walk = Math.max(1,Math.ceil(dist/80));
      const link = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=18/${lat}/${lon}`;
      html+=`<tr><td><a href="${link}" target="_blank">${escapeHtml(name)}</a></td><td>${escapeHtml(type)}</td><td>${dist}</td><td>${walk}</td></tr>`;
    });
    html+='</table>'; output.innerHTML=html;
  }catch(err){ output.innerText='Failed — '+(err.message||err); }
  finally{ showSpinner(false); }
}

/* ===== Update map ===== */
function updateMap(lat, lon){
  const bbox = `${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}`;
  const embed = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lon}`;
  document.getElementById('osm-map').src=embed;
}

/* ===== Debounce resize (even mobile) ===== */
let resizeTimeout;
window.addEventListener('resize', ()=>{
  clearTimeout(resizeTimeout);
  resizeTimeout=setTimeout(()=>{
    // on mobile, iframe adjusts naturally; can add extra adjustments if needed
    const mapWrap = document.getElementById('mapFrameWrap');
    mapWrap.style.height=Math.min(window.innerHeight*0.45, 260)+'px';
  },200);
});

/* ===== Wire buttons ===== */
document.getElementById('btnZip').addEventListener('click',getZip);
document.getElementById('btnAddress').addEventListener('click',getAddress);
document.getElementById('btnNearby').addEventListener('click',listNearby);
</script>
</body>
</html>
