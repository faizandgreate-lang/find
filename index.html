<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Location Finder — Canvas Themes</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap');

  :root{
    --card-bg: rgba(255,255,255,0.78);
    --btn-bg: rgba(255,255,255,0.88);
    --accent: #111;
  }

  html,body{height:100%;margin:0;font-family:"Merriweather",serif;-webkit-font-smoothing:antialiased;}
  body{
    display:flex;flex-direction:column;align-items:center;min-height:100vh;
    color:var(--accent);background:#111;overflow:hidden;position:relative;transition:background .6s;
  }

  /* Fullscreen main canvas for backgrounds */
  canvas.bgcanvas{
    position:fixed;left:0;top:0;width:100%;height:100%;z-index:0;pointer-events:none;
    -webkit-transform: translateZ(0);transform: translateZ(0);
  }

  /* Overlay canvas for sparks/ripples (created dynamically when used) */
  canvas.overlay{ position:fixed;left:0;top:0;width:100%;height:100%;z-index:70;pointer-events:none; }

  header{ width:92%;max-width:820px;margin:14px auto 6px;display:flex;align-items:center;justify-content:center;position:relative;gap:20px;z-index:20; }

  .logo-wrap{ display:flex;align-items:center;gap:12px;position:relative; }
  .logo{ width:150px;border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,0.18); animation:logo-breathe 3s ease-in-out infinite; }
  @keyframes logo-breathe{ 0%,100%{transform:scale(1);opacity:.95} 50%{transform:scale(1.04);opacity:1} }

  .tiny-dot{ width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.12); transition:transform .18s; z-index:22; }
  .tiny-dot.left{ margin-right:-12px }
  .tiny-dot.right{ margin-left:-12px }
  .tiny-dot:active{ transform:scale(.92) }

  .controls{ width:92%;max-width:820px;margin:8px auto 6px;display:flex;flex-direction:column;align-items:center;gap:10px;z-index:18; }
  .btn{ padding:10px 20px;border-radius:10px;border:none;background:var(--btn-bg);font-weight:700;color:var(--accent);box-shadow:0 8px 20px rgba(0,0,0,0.12);cursor:pointer;transition:transform .12s; min-width:170px }
  .btn:active{ transform:translateY(1px) }
  .btn.small{min-width:140px;padding:8px 14px}

  #map,#output{ width:92%;max-width:820px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.12);margin:12px 0;background:var(--card-bg);backdrop-filter: blur(6px);z-index:16; }
  #map{ height:300px;overflow:hidden }
  #output{ padding:14px;font-size:14px; color:var(--accent) }

  table{ width:100%;border-collapse:collapse }
  th,td{ padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left }
  th{ background:rgba(255,255,255,0.6);font-weight:700 }
  tr:nth-child(even){ background:rgba(255,255,255,0.02) }

  footer{ width:100%;text-align:center;padding:14px 8px 36px;color:var(--accent);font-size:14px;z-index:16 }
  footer a{ color:var(--accent); font-weight:700; text-decoration:none }
  footer a:hover{text-decoration:underline}

  .theme-btn{ position:fixed;right:16px;bottom:16px;width:48px;height:48px;border-radius:12px;border:none;cursor:pointer;z-index:30;background:linear-gradient(45deg,#fff,#eee);box-shadow:0 10px 30px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center; }
  .theme-dot{ width:18px;height:18px;border-radius:50%;background:var(--accent);box-shadow:0 6px 20px rgba(0,0,0,0.18) }

  /* bloom animation class */
  .bloom{ animation: bloomAnim .86s ease both; }
  @keyframes bloomAnim{
    0%{ filter:brightness(1); transform:scale(1) }
    50%{ filter:brightness(1.5); transform:scale(1.02) }
    100%{ filter:brightness(1); transform:scale(1) }
  }

  /* responsive */
  @media(max-width:520px){
    .logo{ width:120px }
    .tiny-dot{ width:12px;height:12px }
    .theme-btn{ right:12px;bottom:12px;width:44px;height:44px }
    #map{ height:240px }
    .btn{ min-width:140px }
  }
</style>
</head>
<body>
<canvas id="bgCanvas" class="bgcanvas"></canvas>

<header>
  <div class="logo-wrap" role="banner" aria-label="logo area">
    <div id="leftDot" class="tiny-dot" title="Spark" style="background:linear-gradient(180deg,#ffd6e6,#ff9fb0)"></div>
    <img class="logo" src="https://i.ibb.co/jPQz0mKf/Screenshot-2025-11-05-at-8-24-36-PM.png" alt="Logo">
    <div id="rightDot" class="tiny-dot" title="Ripple" style="background:linear-gradient(180deg,#d6f7ff,#6fefff)"></div>
  </div>
</header>

<div class="controls" role="region" aria-label="Main controls">
  <button class="btn small" onclick="getZip()">Get My ZIP Code</button>
  <button class="btn small" onclick="getAddress()">Get My Address</button>
  <button class="btn small" onclick="listNearby()">List Nearby Places</button>
</div>

<div id="map">
  <iframe id="osm-map" width="100%" height="100%" style="border:0" loading="lazy" allowfullscreen
    src="https://www.openstreetmap.org/export/embed.html?bbox=46.665,24.705,46.685,24.725&layer=mapnik&marker=24.7136,46.6753"></iframe>
</div>

<div id="output">Results will appear here</div>

<footer>
  <a href="https://www.instagram.com/mohammad_faizan_khan_/" target="_blank" rel="noopener">@mohammad_faizan_khan_</a> |
  <a href="https://mohammad.faizan.khan.linux-aios.com" target="_blank" rel="noopener">mohammad.faizan.khan.linux-aios.com</a>
  <div style="margin-top:10px; font-weight:600;">
    Thank you for visit — I made this to help peoples to find zipcode locations and near places by walking distance.
    <br>Myself Mohammad Faizan Khan — hope it will help.
  </div>
</footer>

<button class="theme-btn" id="themeBtn" aria-label="change theme" title="Change Theme">
  <div class="theme-dot" id="themeDot"></div>
</button>

<script>
/* ------------- Theme & visuals setup ------------- */
const themeBtn = document.getElementById('themeBtn');
const themeDot = document.getElementById('themeDot');
const leftDot = document.getElementById('leftDot');
const rightDot = document.getElementById('rightDot');
const bgCanvas = document.getElementById('bgCanvas');
const bgCtx = bgCanvas.getContext('2d');
let DPR = Math.max(1, window.devicePixelRatio || 1);
let W = innerWidth, H = innerHeight;
bgCanvas.width = Math.floor(W * DPR);
bgCanvas.height = Math.floor(H * DPR);
bgCanvas.style.width = W + 'px';
bgCanvas.style.height = H + 'px';
bgCtx.setTransform(DPR,0,0,DPR,0,0);

window.addEventListener('resize', () => {
  W = innerWidth; H = innerHeight;
  DPR = Math.max(1, window.devicePixelRatio || 1);
  bgCanvas.width = Math.floor(W * DPR);
  bgCanvas.height = Math.floor(H * DPR);
  bgCanvas.style.width = W + 'px';
  bgCanvas.style.height = H + 'px';
  bgCtx.setTransform(DPR,0,0,DPR,0,0);
  // reset per-theme if needed
});

/* theme index 1..10 */
let themeIndex = 1;
const maxThemes = 10;

/* theme palette and settings (each has parameters for canvas anim) */
const themes = {
  1: { name:'Clouds', accent:'#1b1b1b', btn:'#ffffff', fn: drawClouds },
  2: { name:'Water', accent:'#083d77', btn:'#c2e9fb', fn: drawWater },
  3: { name:'Volcano', accent:'#2b0606', btn:'#ffd2b6', fn: drawVolcano },
  4: { name:'Galaxy', accent:'#e6e9ff', btn:'#a6c1ee', fn: drawGalaxy },
  5: { name:'Aurora', accent:'#05386b', btn:'#9fffd0', fn: drawAurora },
  6: { name:'Fireflies', accent:'#2b2b2b', btn:'#fff8b5', fn: drawFireflies },
  7: { name:'SoftWaves', accent:'#063c59', btn:'#bfe9ff', fn: drawSoftWaves },
  8: { name:'Nebula', accent:'#f5f0ff', btn:'#f7c9ff', fn: drawNebula },
  9: { name:'Particles', accent:'#111', btn:'#c1ffc1', fn: drawParticles },
  10:{ name:'Bubbles', accent:'#062a3b', btn:'#d6f7ff', fn: drawBubbles }
};

/* apply theme visuals: accent colors on UI */
function applyTheme(i){
  themeIndex = i;
  const t = themes[i];
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--card-bg','rgba(255,255,255,0.78)');
  themeDot.style.background = t.accent;
  // tiny dot colors
  leftDot.style.background = `linear-gradient(180deg, rgba(255,255,255,0.9), ${t.accent})`;
  rightDot.style.background = `linear-gradient(180deg, rgba(255,255,255,0.9), ${t.accent})`;
  // bloom
  document.body.classList.add('bloom');
  setTimeout(()=>document.body.classList.remove('bloom'),860);
}
applyTheme(themeIndex);

/* theme switcher */
themeBtn.addEventListener('click', ()=>{
  themeIndex = themeIndex >= maxThemes ? 1 : themeIndex+1;
  applyTheme(themeIndex);
  // tiny pulse
  themeBtn.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:260});
});

/* -------------------- Background animation engine -------------------- */
/* We create a loop that calls the selected theme's draw function.
   Keep the visuals lightweight: limited particles, small math. */

let lastTime = 0;
let animationId = 0;

/* common helpers */
function rand(min,max){ return Math.random()*(max-min)+min; }
function lerp(a,b,t){ return a + (b-a)*t; }
function ease(t){ return t<.5 ? 2*t*t : -1 + (4 - 2*t)*t; }

/* cloud layers (fast & light) */
let cloudLayers = [];
function setupClouds(){
  cloudLayers = [];
  const count = Math.max(4, Math.floor(W/120));
  for(let i=0;i<count;i++){
    cloudLayers.push({
      x: rand(-W, W), y: rand(H*0.05, H*0.6),
      s: rand(0.6, 1.8), v: rand(0.1, 0.4),
      alpha: rand(0.08,0.24)
    });
  }
}
function drawClouds(dt){
  bgCtx.clearRect(0,0,W,H);
  // soft gradient sky
  const g = bgCtx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#e3f2fd'); g.addColorStop(1,'#b5fffc');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,W,H);
  // draw clouds
  cloudLayers.forEach(c => {
    c.x += c.v * dt * 0.06;
    if(c.x > W + 200) c.x = -300;
    bgCtx.globalAlpha = c.alpha;
    drawCloudShape(c.x, c.y, c.s);
  });
  bgCtx.globalAlpha = 1;
}
function drawCloudShape(x,y,s){
  const w = 180 * s, h = 60 * s;
  bgCtx.beginPath();
  bgCtx.ellipse(x, y, w*0.6, h*0.7, 0, 0, Math.PI*2);
  bgCtx.ellipse(x+60*s, y-10*s, w*0.5, h*0.6, 0, 0, Math.PI*2);
  bgCtx.ellipse(x-60*s, y-6*s, w*0.5, h*0.6, 0, 0, Math.PI*2);
  bgCtx.fillStyle = '#ffffff';
  bgCtx.fill();
}

/* water: soft sin wave + subtle gradient */
let waterPhase = 0;
function drawWater(dt){
  bgCtx.clearRect(0,0,W,H);
  // gradient
  const g = bgCtx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#b3ecff'); g.addColorStop(1,'#8ed1ff');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,W,H);
  // waves
  waterPhase += dt * 0.002;
  const amplitude = Math.min(40, H*0.03);
  bgCtx.globalAlpha = 0.85;
  for(let k=0;k<3;k++){
    bgCtx.beginPath();
    const yBase = H*0.6 + k*18;
    for(let x=0;x<=W;x+=10){
      const y = yBase + Math.sin((x*0.01) + waterPhase*(1+k*0.4)) * amplitude * (0.6 + k*0.2);
      if(x===0) bgCtx.moveTo(x,y); else bgCtx.lineTo(x,y);
    }
    bgCtx.lineTo(W,H); bgCtx.lineTo(0,H); bgCtx.closePath();
    bgCtx.fillStyle = `rgba(255,255,255,${0.06 + k*0.02})`;
    bgCtx.fill();
  }
  bgCtx.globalAlpha = 1;
}

/* volcano: glow + lava blobs */
let lavaBlobs = [];
function setupVolcano(){
  lavaBlobs = [];
  for(let i=0;i<12;i++){
    lavaBlobs.push({x: W*0.5 + rand(-60,60), y: H*0.65 + rand(-20,40), vx: rand(-0.4,0.4), vy: rand(-1.6,-0.6), life: rand(60,160)});
  }
}
function drawVolcano(dt){
  bgCtx.clearRect(0,0,W,H);
  // smoky sky
  const g = bgCtx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#2b0b0b'); g.addColorStop(1,'#4b1d07');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,W,H);
  // mountain silhouette
  bgCtx.fillStyle = '#22110b';
  bgCtx.beginPath();
  bgCtx.moveTo(0,H);
  bgCtx.lineTo(W*0.35,H*0.6);
  bgCtx.lineTo(W*0.5,H*0.7);
  bgCtx.lineTo(W*0.63,H*0.58);
  bgCtx.lineTo(W,H);
  bgCtx.closePath();
  bgCtx.fill();
  // lava blobs
  lavaBlobs.forEach(b=>{
    b.x += b.vx * dt * 0.06;
    b.y += b.vy * dt * 0.06;
    b.vy += 0.04;
    b.life--;
    if(b.life < 0){ b.x = W*0.5 + rand(-60,60); b.y = H*0.65 + rand(-20,40); b.vx = rand(-0.4,0.4); b.vy = rand(-1.4,-0.6); b.life = rand(60,160); }
    // glow
    const grd = bgCtx.createRadialGradient(b.x,b.y,0,b.x,b.y,24);
    grd.addColorStop(0,'rgba(255,255,200,0.9)'); grd.addColorStop(0.4,'rgba(255,120,30,0.7)'); grd.addColorStop(1,'rgba(255,40,0,0)');
    bgCtx.fillStyle = grd;
    bgCtx.beginPath(); bgCtx.arc(b.x,b.y,18,0,Math.PI*2); bgCtx.fill();
  });
}

/* galaxy: rotating particles and faint starfield */
let stars = [];
function setupGalaxy(){
  stars = [];
  for(let i=0;i<120;i++){
    stars.push({x: rand(0,W), y: rand(0,H), r: rand(0.3,1.6), vx: rand(-0.03,0.03), vy: rand(-0.03,0.03), alpha: rand(0.2,1)});
  }
}
function drawGalaxy(dt){
  bgCtx.clearRect(0,0,W,H);
  // deep gradient
  const g = bgCtx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#020617'); g.addColorStop(1,'#0b1947');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,W,H);
  // stars
  for(const s of stars){
    s.x += s.vx * dt * 0.02; s.y += s.vy * dt * 0.02;
    if(s.x < 0) s.x = W; if(s.x>W) s.x = 0; if(s.y<0) s.y = H; if(s.y>H) s.y = 0;
    bgCtx.globalAlpha = s.alpha;
    bgCtx.fillStyle = '#ffffff';
    bgCtx.beginPath(); bgCtx.arc(s.x,s.y,s.r,0,Math.PI*2); bgCtx.fill();
  }
  bgCtx.globalAlpha = 1;
  // faint spiral
  bgCtx.save();
  bgCtx.translate(W/2,H/2);
  bgCtx.rotate((Date.now()%60000)/60000 * Math.PI*2 * 0.02);
  for(let i=0;i<30;i++){
    const a = i/30 * Math.PI*8;
    const r = 6 + i*8;
    bgCtx.beginPath();
    bgCtx.fillStyle = `rgba(255,255,255,${0.02 + (i%3)*0.01})`;
    bgCtx.arc(Math.cos(a)*r, Math.sin(a)*r, 1.2,0,Math.PI*2);
    bgCtx.fill();
  }
  bgCtx.restore();
}

/* aurora: layered sin waves colored */
let aurLayers = [];
function setupAurora(){
  aurLayers = [];
  for(let i=0;i<4;i++){
    aurLayers.push({phase:rand(0,Math.PI*2), amp:rand(20,80), speed:rand(0.0006,0.002), hue:rand(120,200), yBase: rand(H*0.22, H*0.45)});
  }
}
function drawAurora(dt){
  bgCtx.clearRect(0,0,W,H);
  const g = bgCtx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#00111a'); g.addColorStop(1,'#052830');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,W,H);
  aurLayers.forEach(layer=>{
    layer.phase += layer.speed * dt;
    bgCtx.globalAlpha = 0.12;
    bgCtx.beginPath();
    for(let x=0;x<=W;x+=10){
      const y = layer.yBase + Math.sin((x*0.008) + layer.phase) * layer.amp * (0.6 + Math.sin(layer.phase)*0.4);
      if(x===0) bgCtx.moveTo(x,y); else bgCtx.lineTo(x,y);
    }
    bgCtx.lineTo(W,H); bgCtx.lineTo(0,H); bgCtx.closePath();
    bgCtx.fillStyle = `hsl(${layer.hue} 80% 60%)`;
    bgCtx.fill();
  });
  bgCtx.globalAlpha = 1;
}

/* fireflies: floating glowing points */
let fireflies = [];
function setupFireflies(){
  fireflies = [];
  const count = Math.max(18, Math.floor(W/60));
  for(let i=0;i<count;i++){
    fireflies.push({x:rand(0,W), y:rand(0,H*0.6), vx:rand(-0.3,0.3), vy:rand(-0.2,0.2), r:rand(1,3), t:rand(0,Math.PI*2)});
  }
}
function drawFireflies(dt){
  bgCtx.clearRect(0,0,W,H);
  const g = bgCtx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#041018'); g.addColorStop(1,'#062a1f');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,W,H);
  fireflies.forEach(f=>{
    f.x += f.vx * dt * 0.02; f.y += f.vy * dt * 0.02; f.t += 0.02;
    if(f.x<0) f.x = W; if(f.x>W) f.x = 0; if(f.y<0) f.y = H*0.6; if(f.y>H*0.6) f.y = 0;
    const a = 0.4 + Math.sin(f.t)*0.6;
    const grd = bgCtx.createRadialGradient(f.x,f.y,0,f.x,f.y,10);
    grd.addColorStop(0,`rgba(255,255,180,${a})`); grd.addColorStop(1,'rgba(255,255,180,0)');
    bgCtx.fillStyle = grd; bgCtx.beginPath(); bgCtx.arc(f.x,f.y,6,0,Math.PI*2); bgCtx.fill();
  });
}

/* soft waves: layered smooth waves */
let waveLayers = [];
function setupWaves(){
  waveLayers = [];
  for(let i=0;i<3;i++) waveLayers.push({phase:rand(0,6), amp:rand(12,38), speed:rand(0.0008,0.0024), yBase: H*0.6 + i*18 });
}
function drawSoftWaves(dt){
  bgCtx.clearRect(0,0,W,H);
  const g = bgCtx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#e8faff'); g.addColorStop(1,'#c8eefc');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,W,H);
  waveLayers.forEach((w,i)=>{
    w.phase += w.speed * dt;
    bgCtx.globalAlpha = 0.9 - i*0.18;
    bgCtx.beginPath();
    for(let x=0;x<=W;x+=8){
      const y = w.yBase + Math.sin((x*0.012) + w.phase) * w.amp;
      if(x===0) bgCtx.moveTo(x,y); else bgCtx.lineTo(x,y);
    }
    bgCtx.lineTo(W,H); bgCtx.lineTo(0,H); bgCtx.closePath();
    bgCtx.fillStyle = `rgba(255,255,255,${0.06 + i*0.02})`;
    bgCtx.fill();
  });
  bgCtx.globalAlpha = 1;
}

/* nebula: soft blotches, low particle count */
let nebulaBlobs = [];
function setupNebula(){
  nebulaBlobs = [];
  for(let i=0;i<6;i++){
    nebulaBlobs.push({x:rand(0,W), y:rand(0,H*0.6), r:rand(80,180), hue:rand(240,320), vel:rand(0.02,0.08)});
  }
}
function drawNebula(dt){
  bgCtx.clearRect(0,0,W,H);
  bgCtx.fillStyle = '#070018'; bgCtx.fillRect(0,0,W,H);
  nebulaBlobs.forEach(b=>{
    b.x += Math.sin(Date.now()*0.0003 + b.hue) * 0.02;
    const grd = bgCtx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r);
    grd.addColorStop(0,`hsla(${b.hue},80%,65%,0.35)`);
    grd.addColorStop(0.5,`hsla(${(b.hue+40)%360},80%,55%,0.18)`);
    grd.addColorStop(1,'rgba(0,0,0,0)');
    bgCtx.fillStyle = grd;
    bgCtx.beginPath(); bgCtx.arc(b.x,b.y,b.r,0,Math.PI*2); bgCtx.fill();
  });
}

/* particles: many small moving dots */
let smallParticles = [];
function setupParticles(){
  smallParticles = [];
  const count = Math.max(60, Math.floor(W/10));
  for(let i=0;i<count;i++) smallParticles.push({x:rand(0,W),y:rand(0,H),vx:rand(-0.2,0.2),vy:rand(-0.2,0.2),r:rand(0.5,2)});
}
function drawParticles(dt){
  bgCtx.clearRect(0,0,W,H);
  bgCtx.fillStyle = '#0b1220'; bgCtx.fillRect(0,0,W,H);
  bgCtx.globalAlpha = 0.9;
  smallParticles.forEach(p=>{
    p.x += p.vx * dt * 0.02; p.y += p.vy * dt * 0.02;
    if(p.x<0) p.x=W; if(p.x>W) p.x=0; if(p.y<0) p.y=H; if(p.y>H) p.y=0;
    bgCtx.fillStyle = 'rgba(255,255,255,0.7)';
    bgCtx.beginPath(); bgCtx.arc(p.x,p.y,p.r,0,Math.PI*2); bgCtx.fill();
  });
  bgCtx.globalAlpha = 1;
}

/* bubbles: floating translucent circles */
let bubbles = [];
function setupBubbles(){
  bubbles = [];
  const count = Math.max(18, Math.floor(W/80));
  for(let i=0;i<count;i++) bubbles.push({x:rand(0,W),y:rand(H, H*1.2),r:rand(10,38),vy:rand(-0.2,-0.6),alpha:rand(0.08,0.35)});
}
function drawBubbles(dt){
  bgCtx.clearRect(0,0,W,H);
  const g = bgCtx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#f0faff'); g.addColorStop(1,'#c9f4ff');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,W,H);
  bubbles.forEach(b=>{
    b.y += b.vy * dt * 0.02;
    if(b.y + b.r < -20){ b.y = H + rand(20,200); b.x = rand(0,W); }
    const grd = bgCtx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r);
    grd.addColorStop(0,`rgba(255,255,255,${b.alpha})`); grd.addColorStop(1,'rgba(255,255,255,0)');
    bgCtx.fillStyle = grd; bgCtx.beginPath(); bgCtx.arc(b.x,b.y,b.r,0,Math.PI*2); bgCtx.fill();
  });
}

/* Setup per-theme */
function setupTheme(i){
  // initialize resources for chosen theme
  if(i===1) setupClouds();
  if(i===2) waterPhase = 0;
  if(i===3) setupVolcano();
  if(i===4) setupGalaxy();
  if(i===5) setupAurora();
  if(i===6) setupFireflies();
  if(i===7) setupWaves();
  if(i===8) setupNebula();
  if(i===9) setupParticles();
  if(i===10) setupBubbles();
}

/* draw router */
function drawLoop(t){
  const dt = t - lastTime || 16;
  lastTime = t;
  // call chosen theme fn
  const fn = themes[themeIndex].fn;
  if(fn) fn(dt);
  animationId = requestAnimationFrame(drawLoop);
}

/* initialize and start */
setupTheme(themeIndex);
animationId = requestAnimationFrame(drawLoop);

/* when theme changes externally, re-init resources */
function reinitTheme(i){
  applyTheme(i);
  setupTheme(i);
}

/* theme change handler modified to reinit */
themeBtn.addEventListener('click', () => {
  themeIndex = themeIndex >= maxThemes ? 1 : themeIndex + 1;
  reinitTheme(themeIndex);
  // small bloom handled in applyTheme
});

/* ------------------- Spark explosion (left dot) ------------------- */
function sparkEffectAt(x,y){
  // create overlay canvas
  const canvas = document.createElement('canvas');
  canvas.className = 'overlay';
  canvas.width = window.innerWidth * DPR;
  canvas.height = window.innerHeight * DPR;
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  const ctx = canvas.getContext('2d');
  ctx.setTransform(DPR,0,0,DPR,0,0);
  document.body.appendChild(canvas);

  const particles = [];
  const count = 40; // mobile-safe
  for(let i=0;i<count;i++){
    const a = Math.random()*Math.PI*2;
    const s = Math.random()*3+1;
    particles.push({ x, y, vx:Math.cos(a)*(1+Math.random()*3), vy:Math.sin(a)*(1+Math.random()*3), life: 60+Math.random()*40, size:s, col: `hsl(${rand(0,60)},100%,70%)` });
  }

  function anim(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.06; p.life--;
      ctx.globalAlpha = Math.max(0, p.life / 100);
      ctx.fillStyle = p.col;
      ctx.beginPath(); ctx.arc(p.x, p.y, Math.max(0.3, p.size), 0, Math.PI*2); ctx.fill();
      if(p.life<=0) particles.splice(i,1);
    }
    if(particles.length>0) requestAnimationFrame(anim); else document.body.removeChild(canvas);
  }
  anim();
}

/* left dot click handler: compute logo center then spark */
leftDot.addEventListener('click', (ev)=>{
  const logo = document.querySelector('.logo');
  const r = logo.getBoundingClientRect();
  const cx = r.left + r.width/2 + rand(-6,6);
  const cy = r.top + r.height/2 + rand(-6,6);
  sparkEffectAt(cx, cy);
  themeBtn.animate([{transform:'scale(1)'},{transform:'scale(.94)'},{transform:'scale(1)'}],{duration:320});
});

/* ------------------- Ripple (right dot) ------------------- */
function rippleAt(x,y){
  const canvas = document.createElement('canvas');
  canvas.className = 'overlay';
  canvas.width = window.innerWidth * DPR;
  canvas.height = window.innerHeight * DPR;
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  const ctx = canvas.getContext('2d');
  ctx.setTransform(DPR,0,0,DPR,0,0);
  document.body.appendChild(canvas);

  const rings = [];
  for(let i=0;i<3;i++) rings.push({r:8 + i*18, lw: 30 - i*6, life: 0, max: 100 + i*30, alpha: 0.8 - i*0.22});

  function anim(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let i=rings.length-1;i>=0;i--){
      const s = rings[i];
      s.life += 2.6;
      const prog = s.life / s.max;
      if(prog>1) continue;
      ctx.beginPath();
      ctx.lineWidth = Math.max(1, s.lw * (1 - prog));
      ctx.strokeStyle = `rgba(255,255,255,${Math.max(0, s.alpha * (1 - prog))})`;
      ctx.arc(x, y, s.r + s.life*0.8, 0, Math.PI*2);
      ctx.stroke();
    }
    if(rings.some(r => r.life < r.max)) requestAnimationFrame(anim); else document.body.removeChild(canvas);
  }
  anim();
}

rightDot.addEventListener('click', (ev)=>{
  const logo = document.querySelector('.logo');
  const r = logo.getBoundingClientRect();
  const cx = r.left + r.width/2 + rand(-6,6);
  const cy = r.top + r.height/2 + rand(-6,6);
  rippleAt(cx, cy);
  themeBtn.animate([{opacity:1},{opacity:.6},{opacity:1}],{duration:320});
});

/* --------------- GEO / MAP functions (unchanged logic) --------------- */
function getLocation() {
  return new Promise((resolve, reject) => {
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos => resolve({lat: pos.coords.latitude, lon: pos.coords.longitude}),
      err => reject("Location access denied or unavailable"));
    } else reject("Geolocation not supported");
  });
}
async function getZip() {
  try {
    const loc = await getLocation();
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${loc.lat}&lon=${loc.lon}&format=json`);
    const data = await res.json();
    document.getElementById('output').innerText = "ZIP Code: " + (data.address && data.address.postcode ? data.address.postcode : "Not found");
    updateMap(loc.lat, loc.lon);
  } catch(err) { document.getElementById('output').innerText = err; }
}
async function getAddress() {
  try {
    const loc = await getLocation();
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${loc.lat}&lon=${loc.lon}&format=json`);
    const data = await res.json();
    document.getElementById('output').innerText = "Address: " + (data.display_name || "Not found");
    updateMap(loc.lat, loc.lon);
  } catch(err) { document.getElementById('output').innerText = err; }
}
function getDistance(lat1, lon1, lat2, lon2){
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return (R*c).toFixed(2);
}
async function listNearby() {
  try {
    const loc = await getLocation();
    updateMap(loc.lat, loc.lon);
    const query = `[out:json];node(around:1000,${loc.lat},${loc.lon})[amenity];out;`;
    const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
    const data = await res.json();
    if(data.elements && data.elements.length > 0){
      let html = `<table><tr><th>Place</th><th>Type</th><th>Dist (km)</th><th>Walk (min)</th></tr>`;
      data.elements.slice(0,20).forEach(el=>{
        const name = (el.tags && (el.tags['name:en'] || el.tags.name)) || (el.tags ? el.tags.amenity : "Place");
        const type = (el.tags && el.tags.amenity) || "Unknown";
        const dist = getDistance(loc.lat, loc.lon, el.lat, el.lon);
        const time = Math.ceil(dist / 0.083);
        const link = `https://www.openstreetmap.org/?mlat=${el.lat}&mlon=${el.lon}#map=18/${el.lat}/${el.lon}`;
        html += `<tr><td style="word-break:break-word"><a href="${link}" target="_blank" rel="noopener">${escapeHtml(name)}</a></td><td>${escapeHtml(type)}</td><td>${dist}</td><td>${time}</td></tr>`;
      });
      html += `</table>`;
      document.getElementById('output').innerHTML = html;
    } else document.getElementById('output').innerText = "No nearby places found";
  } catch(err){ document.getElementById('output').innerText = "Failed to fetch nearby places"; }
}
function updateMap(lat, lon){
  document.getElementById('osm-map').src = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lon}`;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Ensure theme setup initially */
setupTheme(themeIndex);
applyTheme(themeIndex);

/* start draw loop already started earlier via requestAnimationFrame */
/* (note: drawLoop is running) */
</script>
</body>
</html>
